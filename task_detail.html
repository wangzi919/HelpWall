<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Task Details</title>

<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Patrick+Hand&display=swap" rel="stylesheet"/>

<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          primary: "#20df60",
          "background-light": "#FFFDF5",
          "background-dark": "#112116",
          "accent-yellow": "#FFF5B8",
          "accent-mint": "#D5F0E5",
          "accent-blue": "#C9E9FF",
          "accent-peach": "#FFDDC9",
          "accent-peach": "#FFDDC9",
          "text-main": "#3D3522",
          "text-subtle": "#857E6B",
        },
        fontFamily: {
          display: ["Nunito", "sans-serif"],
          handwritten: ["Patrick Hand", "cursive"],
        },
        borderRadius: {
          DEFAULT: "1.25rem",
          lg: "1.5rem",
          xl: "1.875rem",
          full: "9999px",
        },
        boxShadow: {
          soft: "0 4px 12px rgba(0, 0, 0, 0.05)",
        },
      },
    },
  };
</script>

<style>
  .material-symbols-outlined {
    font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
  }
  body {
    min-height: max(884px, 100dvh);
  }
</style>

</head>
<body class="font-display bg-background-light dark:bg-background-dark text-text-main">

<div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">

<!-- Top Bar -->
<div class="sticky top-0 z-10 flex items-center bg-background-light/80 dark:bg-background-dark/80 p-4 pb-2 justify-between backdrop-blur-sm">
  <button onclick="history.back()" class="flex items-center justify-center rounded-full h-12 w-12 hover:bg-black/5 transition">
    <span class="material-symbols-outlined text-3xl">arrow_back</span>
  </button>
  <h2 class="text-lg font-bold flex-1 text-center">Task Details</h2>
  <button class="flex items-center justify-center rounded-full h-12 w-12">
    <span class="material-symbols-outlined text-3xl">more_horiz</span>
  </button>
</div>

<main class="flex flex-col gap-4 p-4 pb-32">

  <!-- Requester Info -->
  <div class="flex items-center gap-4 bg-white dark:bg-zinc-800 p-4 rounded-xl shadow-soft">
    <div id="user-img" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-16 w-16"></div>
    <div class="flex-1">
      <p id="user-name" class="text-lg font-bold">User</p>
      <p id="post-time" class="text-sm text-text-subtle">Posted ...</p>
    </div>
  </div>

  <!-- Task Card -->
  <div class="bg-white dark:bg-zinc-800 p-6 rounded-xl shadow-soft flex flex-col gap-4 relative">
    <h1 id="task-title" class="text-[28px] font-extrabold leading-tight">Loading...</h1>
    <p id="task-desc" class="text-base leading-relaxed">Loading description...</p>

    <div class="flex gap-3 flex-wrap items-center pt-2">

      <!-- Expected Time tag -->
      <span id="expected-time-box"
            class="px-3 py-1 rounded-full text-sm font-bold bg-accent-mint text-text-main whitespace-nowrap cursor-pointer">
        10 minutes
      </span>

      <!-- Reward tag -->
      <span id="reward-box"
            class="px-3 py-1 rounded-full text-sm font-bold bg-accent-yellow text-text-main whitespace-nowrap flex items-center gap-1">
        +2 <span class="text-lg">â±</span>
      </span>
    </div>
  </div>

  <div class="flex flex-wrap gap-2 justify-start md:justify-end mt-4">
      <button id="edit-desc-button" onclick="openEditDescription()"
              class="hidden px-4 py-2 rounded-full bg-blue-600 shadow-lg font-bold text-white text-sm 
                    md:px-6 md:py-3 md:text-base md:font-extrabold 
                    transition-transform duration-150 active:scale-95 flex items-center gap-1">
        âœï¸ Edit
      </button>
      
      <button id="edit-image-button" onclick="openEditImage()"
              class="hidden px-4 py-2 rounded-full bg-orange-600 shadow-lg font-bold text-white text-sm 
                    md:px-6 md:py-3 md:text-base md:font-extrabold 
                    transition-transform duration-150 active:scale-95 flex items-center gap-1">
        ğŸ–¼ï¸ Image
      </button>
      
      <button id="delete-task-button" onclick="openDeleteConfirmation()"
              class="hidden px-4 py-2 rounded-full bg-red-500 shadow-lg font-bold text-white text-sm 
                    md:px-6 md:py-3 md:text-base md:font-extrabold 
                    transition-transform duration-150 active:scale-95 flex items-center gap-1">
        ğŸ—‘ï¸ Delete
      </button>
  </div>

  <!-- Comments Placeholder -->
  <div class="flex flex-col gap-4">
    <h3 class="font-bold text-lg px-2">Comments</h3>
    <p class="text-text-subtle text-sm px-2">Comments loading feature (future update)â€¦</p>
  </div>

  <!-- Thank You Note -->
  <div id="thanks-card-container" class="hidden relative mt-6 rotate-[-2deg]">
    <div class="absolute top-[-10px] right-[-10px] text-3xl">ğŸ“Œ</div>
    <div class="bg-accent-yellow p-6 rounded-lg shadow-soft flex flex-col items-center text-center gap-3">
      <h3 id="thanks-title" class="font-handwritten text-2xl">A Big Thank You!</h3>
      <p id="thanks-message" class="font-handwritten text-lg leading-snug"></p>
    </div>
  </div>

</main>

<!-- Accept / Complete Buttons -->
<div class="fixed bottom-0 left-0 w-full p-4 bg-background-light dark:bg-background-dark">
  <button id="acceptTaskBtn"
      class="hidden flex w-full cursor-pointer items-center justify-center 
             overflow-hidden rounded-full h-14 bg-accent-mint 
             text-text-main gap-2 text-lg font-bold leading-normal tracking-wide 
             shadow-soft hover:opacity-90">
    Accept This Task
  </button>

  <button id="completeTaskBtn"
      class="hidden mt-3 flex w-full cursor-pointer items-center justify-center 
             overflow-hidden rounded-full h-14 bg-accent-peach 
             text-text-main gap-2 text-lg font-bold leading-normal tracking-wide 
             shadow-soft hover:opacity-90">
    Mark as Completed
  </button>
</div>

<!-- Modalï¼šç·¨è¼¯ Full Description -->
<div id="edit-desc-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl w-80 flex flex-col gap-3">
      <h2 class="font-bold text-lg">Edit Full Description</h2>
      <textarea id="edit-desc-input" class="border p-2 rounded-lg h-32"></textarea>
      <button onclick="saveDescription()" class="bg-primary text-white rounded-lg py-2">Save</button>
      <button onclick="closeEditDescription()" class="text-sm text-gray-500">Cancel</button>
  </div>
</div>

<!-- Modalï¼šç·¨è¼¯ Image URL -->
<div id="edit-img-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl w-80 flex flex-col gap-3">
      <h2 class="font-bold text-lg">Edit Image URL</h2>
      <input id="edit-img-input" class="border p-2 rounded-lg"/>
      <button onclick="saveImageUrl()" class="bg-primary text-white rounded-lg py-2">Save</button>
      <button onclick="closeEditImage()" class="text-sm text-gray-500">Cancel</button>
  </div>
</div>

<!-- Expected Time Picker Modal -->
<div id="time-picker-modal"
     class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-[999]">

  <div class="bg-white dark:bg-zinc-800 p-6 rounded-xl w-72 shadow-xl flex flex-col gap-3">

    <h2 class="text-lg font-bold mb-2">Select Expected Time</h2>

    <div class="flex flex-col gap-2">
      <button class="time-option px-4 py-2 rounded-lg bg-accent-mint" data-minute="5">5 minutes</button>
      <button class="time-option px-4 py-2 rounded-lg bg-accent-mint" data-minute="10">10 minutes</button>
      <button class="time-option px-4 py-2 rounded-lg bg-accent-mint" data-minute="15">15 minutes</button>
      <button class="time-option px-4 py-2 rounded-lg bg-accent-mint" data-minute="20">20 minutes</button>
      <button class="time-option px-4 py-2 rounded-lg bg-accent-mint" data-minute="25">25 minutes</button>
      <button class="time-option px-4 py-2 rounded-lg bg-accent-mint" data-minute="30">30 minutes</button>
    </div>

    <button onclick="closeTimePicker()"
            class="mt-4 px-4 py-2 rounded-full bg-gray-300 dark:bg-zinc-700">
      Cancel
    </button>
  </div>
</div>

<!-- åˆªé™¤ç¢ºèªè¦–çª— -->
<div id="delete-modal"
     class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-[999]">
  <div class="bg-white dark:bg-zinc-800 p-6 rounded-xl shadow-xl w-80 flex flex-col gap-4">
    <h2 class="text-lg font-bold text-red-600">Delete Task?</h2>
    <p class="text-text-main dark:text-gray-200 text-sm">
      This action cannot be undone.  
      Are you sure you want to delete this task?
    </p>

    <div class="flex justify-end gap-3 mt-4">
      <button onclick="closeDeleteConfirmation()"
              class="px-4 py-2 rounded-full bg-gray-200 dark:bg-zinc-700">
        Cancel
      </button>
      <button onclick="confirmDeleteTask()"
              class="px-4 py-2 rounded-full bg-red-500 text-white">
        Delete
      </button>
    </div>
  </div>
</div>

</div>

<!-- Supabase Script -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://zyeykllnefwvlokrecbv.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5ZXlrbGxuZWZ3dmxva3JlY2J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDg2MjQsImV4cCI6MjA3ODYyNDYyNH0.zTx11lXOPAdeakTXQch9OEO4c7rfhMImNaKDz4G9DIs";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const urlParams = new URLSearchParams(window.location.search);
  const taskId = urlParams.get("task_id");
  const userId = urlParams.get("user_id");

  if (!taskId) console.error("âŒ Missing task_id in URL");

  loadTask(taskId);
  checkButtons();
  checkEditPermissions();

  /* -------------------- Load Task ---------------------- */
  async function loadTask(id) {
    const { data: task } = await supabaseClient.from("tasks").select("*").eq("id", id).single();
    if (!task) return;

    const { data: user } = await supabaseClient.from("user").select("*").eq("id", task.user_id).single();
    const { data: detail } = await supabaseClient.from("task_detail").select("*").eq("task_id", id).single();
    const { data: thanks } = await supabaseClient.from("thanks_card").select("*").eq("task_id", id);

    document.getElementById("user-name").textContent = user?.name || "Unknown";
    document.getElementById("user-img").style.backgroundImage = `url('${user?.image_url || ""}')`;
    document.getElementById("post-time").textContent = timeAgo(task.created_at);

    document.getElementById("task-title").textContent = task.title;
    document.getElementById("task-desc").textContent = detail?.full_description || task.description;

    // å¡«å…¥ expected_time
    if (detail?.expected_time) {
      document.getElementById("expected-time-box").textContent = detail.expected_time;
    } else {
      document.getElementById("expected-time-box").textContent = "N/A";
    }

    // å¡«å…¥ time credit reward
    if (detail?.time_credit) {
      document.getElementById("reward-box").textContent = `+${detail.time_credit} â±`;
    } else {
      document.getElementById("reward-box").textContent = "+0 â±";
    }

    // æ„Ÿè¬å¡
    if (thanks && thanks.length > 0) {
      const t = thanks[0];
      document.getElementById("thanks-card-container").classList.remove("hidden");
      document.getElementById("thanks-message").textContent = t.message;
    }
  }

  function timeAgo(timestamp) {
    const diff = (Date.now() - new Date(timestamp)) / 1000;
    if (diff < 60) return "just now";
    if (diff < 3600) return Math.floor(diff/60) + " minutes ago";
    if (diff < 86400) return Math.floor(diff/3600) + " hours ago";
    return Math.floor(diff/86400) + " days ago";
  }

  /* -------------------- Accept Task ---------------------- */
  async function acceptTask() {
    if (!userId) return alert("Please login first.");

    const { data: existing } = await supabaseClient
      .from("task_assignment")
      .select("*")
      .eq("task_id", taskId)
      .eq("status", "in_progress")
      .maybeSingle();

    if (existing) return alert("This task is already taken.");

    const { error } = await supabaseClient
      .from("task_assignment")
      .insert({
        task_id: taskId,
        helper_id: userId,
        status: "in_progress",
      });

    if (error) return alert("Error accepting task.");

    alert("Task accepted!");
    window.location.reload();
  }

  /* -------------------- Complete Task ---------------------- */
  async function completeTask() {
    // 1. å–å¾—ä»»å‹™çš„æ™‚é–“å¹£
    const { data: detail, error: detailErr } = await supabaseClient
      .from("task_detail")
      .select("time_credit")
      .eq("task_id", taskId)
      .single();

    if (detailErr || !detail) {
      console.error(detailErr);
      return alert("ç„¡æ³•è®€å–ä»»å‹™æ™‚é–“å¹£è³‡æ–™");
    }

    const credit = detail.time_credit || 0;

    // 2. æ‰¾åˆ° assignmentï¼ˆçŸ¥é“ helper æ˜¯èª°ï¼‰
    const { data: assignment, error: assignErr } = await supabaseClient
      .from("task_assignment")
      .select("helper_id")
      .eq("task_id", taskId)
      .single();

    if (assignErr || !assignment) {
      console.error(assignErr);
      return alert("æ‰¾ä¸åˆ°ä»»å‹™å”åŠ©è€…");
    }

    const helperId = assignment.helper_id;
    const publisherId = userId; // æŒ‰ä¸‹å®Œæˆè€…æ˜¯ç™¼å¸ƒè€…æœ¬äºº

    // --- 3. æ‰£ ç™¼å¸ƒè€… æ™‚é–“å¹£ ---
    let { error: minusErr } = await supabaseClient.rpc("increment_credit", {
      user_id: publisherId,
      amount: -credit
    });

    if (minusErr) {
      return alert("æ‰£é™¤ç™¼å¸ƒè€…æ™‚é–“å¹£å¤±æ•—ï¼š" + minusErr.message);
    }

    // --- 4. åŠ  çµ¦ helper æ™‚é–“å¹£ ---
    let { error: plusErr } = await supabaseClient.rpc("increment_credit", {
      user_id: helperId,
      amount: credit
    });

    if (plusErr) {
      return alert("å¢åŠ å”åŠ©è€…æ™‚é–“å¹£å¤±æ•—ï¼š" + plusErr.message);
    }

    // --- 5. å¯«å…¥ time_credit_logï¼ˆå…©ç­†ï¼‰---

    await supabaseClient.from("time_credit_log").insert([
      {
        user_id: publisherId,
        related_task: taskId,
        change_amount: -credit,
      },
      {
        user_id: helperId,
        related_task: taskId,
        change_amount: credit,
      }
    ]);

    // --- 6. å°‡ä»»å‹™è¨­ç‚º completed ---
    const { error: statusErr } = await supabaseClient
      .from("task_assignment")
      .update({ status: "completed" })
      .eq("task_id", taskId);

    if (statusErr) {
      console.error(statusErr);
      return alert("Error marking complete.");
    }

    alert("ä»»å‹™å·²å®Œæˆï¼æ™‚é–“å¹£å·²ç™¼çµ¦å”åŠ©è€…ï¼");
    window.location.reload();
  }

  /* -------------------- Show Correct Buttons ---------------------- */
  async function checkButtons() {
    if (!userId) return;

    // è®€å–ä»»å‹™æœ¬èº«ï¼Œå–å¾— task.user_id
    const { data: task } = await supabaseClient
      .from("tasks")
      .select("*")
      .eq("id", taskId)
      .single();

    // è®€å–åª’åˆè³‡è¨Š
    const { data: assignment } = await supabaseClient
      .from("task_assignment")
      .select("*")
      .eq("task_id", taskId)
      .maybeSingle();

    const acceptBtn = document.getElementById("acceptTaskBtn");
    const completeBtn = document.getElementById("completeTaskBtn");

    /* === Accept Task Button === */
    if (!assignment && userId != task.user_id) {
      // æ²’äººæ¥ AND ä¸æ˜¯ç™¼å¸ƒè€… â†’ å¯ä»¥æ¥
      acceptBtn.classList.remove("hidden");
    }

    /* === Complete Task Button (by creator only) === */
    if (
      assignment &&
      assignment.status === "in_progress" &&
      userId == task.user_id     // ä»»å‹™çš„ç™¼å¸ƒè€…
    ) {
      completeBtn.classList.remove("hidden");
    }
  }

  function openEditDescription() {
    document.getElementById("edit-desc-modal").classList.remove("hidden");

    const currentDescElement = document.getElementById("task-desc"); 

    if (currentDescElement) {
      document.getElementById("edit-desc-input").value = 
        currentDescElement.textContent.trim();
    } else {
      console.error("ç„¡æ³•æ‰¾åˆ° ID ç‚º task-desc çš„å…ƒç´ ã€‚");
    }
  }
  function closeEditDescription() {
    document.getElementById("edit-desc-modal").classList.add("hidden");
  }

  function openEditImage() {
    document.getElementById("edit-img-modal").classList.remove("hidden");

    // å¡«å…¥ç›®å‰çš„ image_url
    document.getElementById("edit-img-input").value =
      window.currentTask?.image_url || "";
  }

  function closeEditImage() {
    document.getElementById("edit-img-modal").classList.add("hidden");
  }

  async function saveDescription() {
    const newDesc = document.getElementById("edit-desc-input").value.trim();
    if (!newDesc) return alert("æè¿°ä¸å¯ç‚ºç©º");

    const { error } = await supabaseClient
      .from("task_detail")
      .update({ full_description: newDesc })
      .eq("task_id", taskId);

    if (error) return alert("æ›´æ–°å¤±æ•—ï¼š" + error.message);

    alert("æè¿°å·²æ›´æ–°ï¼");
    document.getElementById("desc-text").textContent = newDesc;
  }

  async function saveImageUrl() {
    const newUrl = document.getElementById("edit-img-input").value.trim();
    if (!newUrl) return alert("åœ–ç‰‡ç¶²å€ä¸å¯ç‚ºç©º");

    const { error } = await supabaseClient
      .from("tasks")
      .update({ image_url: newUrl })
      .eq("id", taskId);

    if (error) return alert("æ›´æ–°å¤±æ•—ï¼š" + error.message);

    alert("åœ–ç‰‡å·²æ›´æ–°ï¼");
    document.getElementById("task-image").style.backgroundImage = `url('${newUrl}')`;
  }

  /* -------------------- Show Edit Buttons ---------------------- */
  async function checkEditPermissions() {
      if (!userId) {
          return;
      }

      const { data: taskData, error: taskError } = await supabaseClient
          .from('tasks')
          .select('user_id')
          .eq('id', taskId)
          .single();
      
      if (taskError || !taskData) {
          console.error("ç„¡æ³•è¼‰å…¥ä»»å‹™è³‡è¨Šæˆ–ä»»å‹™ä¸å­˜åœ¨ã€‚", taskError);
          return;
      }

      const taskOwnerId = taskData.user_id;
      
      const { data: assignmentData, error: assignmentError } = await supabaseClient
          .from('task_assignment')
          .select('id')
          .eq('task_id', taskId)
          .limit(1);

      if (assignmentError) {
          console.error("æª¢æŸ¥ä»»å‹™æ¥å—ç‹€æ…‹æ™‚å‡ºéŒ¯ã€‚", assignmentError);
          hideEditButtons();
          return;
      }

      // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºæŒ‰éˆ•
      const isOwner = userId == taskOwnerId;
      const isAssigned = assignmentData && assignmentData.length > 0;

      // --- åŒæ™‚æ§åˆ¶ Edit Buttons + æ™‚é–“æŒ‰éˆ• ---
      if (isOwner && !isAssigned) {
          showEditButtons();
          enableTimeEditing();
      } else {
          disableTimeEditing();
      }
  }

  /* -------------------- åŸ·è¡Œåˆªé™¤ ---------------------- */
  function showEditButtons() {
      document.getElementById('edit-desc-button').classList.remove('hidden');
      document.getElementById('edit-image-button').classList.remove('hidden');
      document.getElementById('delete-task-button').classList.remove('hidden');
  }

  function openDeleteConfirmation() {
      document.getElementById("delete-modal").classList.remove("hidden");
  }

  function closeDeleteConfirmation() {
      document.getElementById("delete-modal").classList.add("hidden");
  }

  async function confirmDeleteTask() {
      if (!userId) return;

      // 1. åˆªé™¤ task_detail
      await supabaseClient.from("task_detail").delete().eq("task_id", taskId);

      // 2. åˆªé™¤ tasks æœ¬é«”
      const { error } = await supabaseClient
          .from("tasks")
          .delete()
          .eq("id", taskId);

      if (error) {
          alert("åˆªé™¤å¤±æ•—ï¼š" + error.message);
          return;
      }

      // é—œé–‰è¦–çª—èˆ‡è¿”å›ä¸»é 
      closeDeleteConfirmation();
      window.location.href = `main.html?user_id=${userId}`;
  }

  /* -------------------- Edit expected time ---------------------- */
  document.getElementById("expected-time-box").onclick = () => {
    document.getElementById("time-picker-modal").classList.remove("hidden");
  };

  function closeTimePicker() {
    document.getElementById("time-picker-modal").classList.add("hidden");
  }

  function disableTimeEditing() {
      const timeButton = document.getElementById("expected-time-box");
      if (timeButton) {
          timeButton.classList.add("opacity-40", "cursor-not-allowed");
          timeButton.onclick = null;  // å–æ¶ˆé»æ“Š
      }
  }

  function enableTimeEditing() {
      const timeButton = document.getElementById("expected-time-box");
      if (timeButton) {
          timeButton.classList.remove("opacity-40", "cursor-not-allowed");
          timeButton.onclick = openTimePicker;  
      }
  }

  document.querySelectorAll(".time-option").forEach(btn => {
    btn.addEventListener("click", async () => {

      const minutes = parseInt(btn.dataset.minute);
      const time_credit = minutes / 5; // ä½ çš„è¦å‰‡ï¼šæ¯ 5 min = 1 credit

      // æ›´æ–° UI
      document.getElementById("expected-time-box").textContent = `${minutes} minutes`;
      document.getElementById("reward-box").innerHTML = `+${time_credit} <span class="text-lg">â±</span>`;

      // æ›´æ–°åˆ°è³‡æ–™åº«
      const { error } = await supabaseClient
        .from("task_detail")
        .update({
          expected_time: `${minutes} minutes`,
          time_credit: time_credit
        })
        .eq("task_id", taskId);

      if (error) {
        alert("æ›´æ–°å¤±æ•—ï¼š" + error.message);
      }

      closeTimePicker();
    });
  });

  document.getElementById("acceptTaskBtn").addEventListener("click", acceptTask);
  document.getElementById("completeTaskBtn").addEventListener("click", completeTask);
</script>

</body>
</html>
