<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Task Details</title>

<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Patrick+Hand&display=swap" rel="stylesheet"/>

<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          primary: "#20df60",
          "background-light": "#FFFDF5",
          "background-dark": "#112116",
          "accent-yellow": "#FFF5B8",
          "accent-mint": "#D5F0E5",
          "accent-blue": "#C9E9FF",
          "accent-peach": "#FFDDC9",
          "accent-peach": "#FFDDC9",
          "text-main": "#3D3522",
          "text-subtle": "#857E6B",
        },
        fontFamily: {
          display: ["Nunito", "sans-serif"],
          handwritten: ["Patrick Hand", "cursive"],
        },
        borderRadius: {
          DEFAULT: "1.25rem",
          lg: "1.5rem",
          xl: "1.875rem",
          full: "9999px",
        },
        boxShadow: {
          soft: "0 4px 12px rgba(0, 0, 0, 0.05)",
        },
      },
    },
  };
</script>

<style>
  .material-symbols-outlined {
    font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
  }
  body {
    min-height: max(884px, 100dvh);
  }
</style>

</head>
<body class="font-display bg-background-light dark:bg-background-dark text-text-main">

<div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">

<!-- Top Bar -->
<div class="sticky top-0 z-10 flex items-center bg-background-light/80 dark:bg-background-dark/80 p-4 pb-2 justify-between backdrop-blur-sm">
  <button onclick="window.location.href=`main.html?user_id=${userId}`" class="flex items-center justify-center rounded-full h-12 w-12 hover:bg-black/5 transition">
    <span class="material-symbols-outlined text-3xl">arrow_back</span>
  </button>
  <h2 class="text-lg font-bold flex-1 text-center">Task Details</h2>
  <button class="flex items-center justify-center rounded-full h-12 w-12">
    <span class="material-symbols-outlined text-3xl">more_horiz</span>
  </button>
</div>

<main class="flex flex-col gap-4 p-4 pb-32">

  <!-- Requester Info -->
  <div class="flex items-center gap-4 bg-white dark:bg-zinc-800 p-4 rounded-xl shadow-soft">
    <div id="user-img" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-16 w-16"></div>
    <div class="flex-1">
      <p id="user-name" class="text-lg font-bold">User</p>
      <p id="post-time" class="text-sm text-text-subtle">Posted ...</p>
    </div>
  </div>

  <!-- Task Card -->
  <div class="bg-white dark:bg-zinc-800 p-6 rounded-xl shadow-soft flex flex-col gap-4">
    <h1 id="task-title" class="text-[28px] font-extrabold leading-tight">Loading...</h1>
    <p id="task-desc" class="text-base leading-relaxed">Loading description...</p>
  </div>

  <!-- Comments Placeholder -->
  <div class="flex flex-col gap-4">
    <h3 class="font-bold text-lg px-2">Comments</h3>
    <p class="text-text-subtle text-sm px-2">Comments loading feature (future update)â€¦</p>
  </div>

  <!-- Thank You Note -->
  <div id="thanks-card-container" class="hidden relative mt-6 rotate-[-2deg]">
    <div class="absolute top-[-10px] right-[-10px] text-3xl">ðŸ“Œ</div>
    <div class="bg-accent-yellow p-6 rounded-lg shadow-soft flex flex-col items-center text-center gap-3">
      <h3 id="thanks-title" class="font-handwritten text-2xl">A Big Thank You!</h3>
      <p id="thanks-message" class="font-handwritten text-lg leading-snug"></p>
    </div>
  </div>

</main>

<!-- Accept / Complete Buttons -->
<div class="fixed bottom-0 left-0 w-full p-4 bg-background-light dark:bg-background-dark">
  <button id="acceptTaskBtn"
      class="hidden flex w-full cursor-pointer items-center justify-center 
             overflow-hidden rounded-full h-14 bg-accent-mint 
             text-text-main gap-2 text-lg font-bold leading-normal tracking-wide 
             shadow-soft hover:opacity-90">
    Accept This Task
  </button>

  <button id="completeTaskBtn"
      class="hidden mt-3 flex w-full cursor-pointer items-center justify-center 
             overflow-hidden rounded-full h-14 bg-accent-peach 
             text-text-main gap-2 text-lg font-bold leading-normal tracking-wide 
             shadow-soft hover:opacity-90">
    Mark as Completed
  </button>
</div>

</div>

<!-- Supabase Script -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://zyeykllnefwvlokrecbv.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5ZXlrbGxuZWZ3dmxva3JlY2J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDg2MjQsImV4cCI6MjA3ODYyNDYyNH0.zTx11lXOPAdeakTXQch9OEO4c7rfhMImNaKDz4G9DIs";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const urlParams = new URLSearchParams(window.location.search);
  const taskId = urlParams.get("task_id");
  const userId = urlParams.get("user_id");

  if (!taskId) console.error("âŒ Missing task_id in URL");

  loadTask(taskId);
  checkButtons();

  /* -------------------- Load Task ---------------------- */
  async function loadTask(id) {
    const { data: task } = await supabaseClient.from("tasks").select("*").eq("id", id).single();
    if (!task) return;

    const { data: user } = await supabaseClient.from("user").select("*").eq("id", task.user_id).single();
    const { data: detail } = await supabaseClient.from("task_detail").select("*").eq("task_id", id).single();
    const { data: thanks } = await supabaseClient.from("thanks_card").select("*").eq("task_id", id);

    document.getElementById("user-name").textContent = user?.name || "Unknown";
    document.getElementById("user-img").style.backgroundImage = `url('${user?.image_url || ""}')`;
    document.getElementById("post-time").textContent = timeAgo(task.created_at);

    document.getElementById("task-title").textContent = task.title;
    document.getElementById("task-desc").textContent = detail?.full_description || task.description;

    // æ„Ÿè¬å¡
    if (thanks && thanks.length > 0) {
      const t = thanks[0];
      document.getElementById("thanks-card-container").classList.remove("hidden");
      document.getElementById("thanks-message").textContent = t.message;
    }
  }

  function timeAgo(timestamp) {
    const diff = (Date.now() - new Date(timestamp)) / 1000;
    if (diff < 60) return "just now";
    if (diff < 3600) return Math.floor(diff/60) + " minutes ago";
    if (diff < 86400) return Math.floor(diff/3600) + " hours ago";
    return Math.floor(diff/86400) + " days ago";
  }

  /* -------------------- Accept Task ---------------------- */
  async function acceptTask() {
    if (!userId) return alert("Please login first.");

    const { data: existing } = await supabaseClient
      .from("task_assignment")
      .select("*")
      .eq("task_id", taskId)
      .eq("status", "in_progress")
      .maybeSingle();

    if (existing) return alert("This task is already taken.");

    const { error } = await supabaseClient
      .from("task_assignment")
      .insert({
        task_id: taskId,
        helper_id: userId,
        status: "in_progress",
      });

    if (error) return alert("Error accepting task.");

    alert("Task accepted!");
    window.location.reload();
  }

  /* -------------------- Complete Task ---------------------- */
  async function completeTask() {
    // 1. å–å¾—ä»»å‹™è³‡è¨Šï¼ˆåŒ…å« rewardï¼‰
    const { data: task, error: taskError } = await supabaseClient
      .from("task_detail")
      .select("time_credit")
      .eq("id", taskId)
      .single();

    if (taskError) {
      console.error(taskError);
      return alert("ç„¡æ³•è®€å–ä»»å‹™è³‡æ–™");
    }

    const time_credit = task.time_credit || 0;

    // 2. æ‰¾åˆ°è©²ä»»å‹™çš„ assignmentï¼ˆçŸ¥é“ helper æ˜¯èª°ï¼‰
    const { data: assignment, error: assignError } = await supabaseClient
      .from("task_assignment")
      .select("helper_id")
      .eq("task_id", taskId)
      .single();

    if (assignError || !assignment) {
      console.error(assignError);
      return alert("æ‰¾ä¸åˆ°ä»»å‹™è² è²¬äºº");
    }

    const helperId = assignment.helper_id;

    // 3. ç›´æŽ¥æ›´æ–° users.time_credit = time_credit + reward
    const { error: creditError } = await supabaseClient
      .rpc("increment_credit", {user_id: helperId, amount: time_credit});

    if (creditError) {
      alert("å¢žåŠ æ™‚é–“å¹£å¤±æ•—ï¼š" + creditError.message);
      return;
    }

    // 4. æŠŠä»»å‹™æ¨™è¨˜ç‚ºå®Œæˆ
    const { error: statusError } = await supabaseClient
      .from("task_assignment")
      .update({ status: "completed" })
      .eq("task_id", taskId);

    if (statusError) {
      console.error(statusError);
      return alert("Error marking complete.");
    }

    alert("ä»»å‹™å·²å®Œæˆï¼æ™‚é–“å¹£å·²ç™¼çµ¦å”åŠ©è€…ï¼");
    window.location.reload();
  }

  /* -------------------- Show Correct Buttons ---------------------- */
  async function checkButtons() {
    if (!userId) return;

    // è®€å–ä»»å‹™æœ¬èº«ï¼Œå–å¾— task.user_id
    const { data: task } = await supabaseClient
      .from("tasks")
      .select("*")
      .eq("id", taskId)
      .single();

    // è®€å–åª’åˆè³‡è¨Š
    const { data: assignment } = await supabaseClient
      .from("task_assignment")
      .select("*")
      .eq("task_id", taskId)
      .maybeSingle();

    const acceptBtn = document.getElementById("acceptTaskBtn");
    const completeBtn = document.getElementById("completeTaskBtn");

    /* === Accept Task Button === */
    if (!assignment && userId != task.user_id) {
      // æ²’äººæŽ¥ AND ä¸æ˜¯ç™¼å¸ƒè€… â†’ å¯ä»¥æŽ¥
      acceptBtn.classList.remove("hidden");
    }

    /* === Complete Task Button (by creator only) === */
    if (
      assignment &&
      assignment.status === "in_progress" &&
      userId == task.user_id     // ä»»å‹™çš„ç™¼å¸ƒè€…
    ) {
      completeBtn.classList.remove("hidden");
    }
  }

  document.getElementById("acceptTaskBtn").addEventListener("click", acceptTask);
  document.getElementById("completeTaskBtn").addEventListener("click", completeTask);
</script>

</body>
</html>
