<!DOCTYPE html>
<html class="light" lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Time Coin Log</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#2b8cee",
            "background-light": "#FFFDF5",
            "background-dark": "#111921"
          },
          fontFamily: {
            display: ["Plus Jakarta Sans", "Noto Sans", "sans-serif"]
          }
        }
      }
    };
  </script>

  <style>
    body { min-height: max(884px, 100dvh); }
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display">

<div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">

    <!-- Top App Bar -->
    <div class="flex items-center p-4 pb-2 sticky top-0 z-10 bg-transparent">
        <button 
            onclick="history.back()" 
            class="flex items-center justify-center rounded-full h-12 w-12 hover:bg-black/5 transition z-20">
            <span class="material-symbols-outlined text-3xl">arrow_back</span>
        </button>

        <h2 class="text-[#111418] dark:text-white text-lg font-bold text-center pointer-events-none absolute left-0 right-0">
            時間幣紀錄
        </h2>
    </div>

  <main class="flex flex-col gap-6 p-4">

    <!-- Balance Display -->
    <div class="flex items-stretch justify-between gap-4 rounded-xl bg-white dark:bg-gray-800 p-6 shadow">
      <div class="flex flex-col gap-2 flex-[2_2_0px]">
        <p class="text-[#617589] dark:text-gray-400 text-sm">我的時間幣</p>
        <div class="flex items-center gap-2">
          <span class="material-symbols-outlined text-primary text-3xl">toll</span>
          <p id="wallet-total" class="text-[#111418] dark:text-white text-3xl font-bold">0</p>
        </div>
      </div>
    </div>

    <!-- Logs -->
    <div id="log-list" class="flex flex-col gap-3"></div>

  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const sb = supabase.createClient(
    "https://zyeykllnefwvlokrecbv.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5ZXlrbGxuZWZ3dmxva3JlY2J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDg2MjQsImV4cCI6MjA3ODYyNDYyNH0.zTx11lXOPAdeakTXQch9OEO4c7rfhMImNaKDz4G9DIs"
  );

  let userId = null;

  async function initLogPage() {
      // 驗證身分
      const { data: { user } } = await sb.auth.getUser();

      // 如果沒登入，踢回首頁
      if (!user) {
          alert("請先登入");
          window.location.href = 'index.html';
          return;
      }

      userId = user.id;
      console.log("Current User UUID:", userId);

      loadWalletTotal();
      loadCreditLogs();
  }

  initLogPage()

  async function loadWalletTotal() {
    const { data: user } = await sb.from("user").select("time_credit").eq("uid", userId).single();
    document.getElementById("wallet-total").textContent = user?.time_credit ?? 0;
  }

  async function loadCreditLogs() {
    const { data: logs } = await sb
      .from("time_credit_log")
      .select("*, tasks(title)")
      .eq("user_uid", userId)
      .order("created_at", { ascending: false });

    const list = document.getElementById("log-list");
    list.innerHTML = "";

    logs.forEach(log => {
      const isGain = log.change_amount > 0;

      const iconColor = isGain ? "#A8D8B9" : "#F7B5A1";
      const bgColor = isGain ? "#A8D8B9" : "#F7B5A1";
      const amountColor = iconColor;
      const sign = isGain ? "+" : "-";

      const title = isGain ? "獲得時間幣" : "付出時間幣";
      const detail = log.description || (log.tasks?.title ? `任務：${log.tasks.title}` : "");

      const item = document.createElement("div");
      item.className =
        "flex items-center gap-4 bg-white dark:bg-gray-800 px-4 py-3 min-h-[72px] justify-between rounded-xl shadow cursor-pointer";

      item.onclick = () => {
        window.location.href = `task_detail.html?task_id=${log.related_task}`;
      };

      item.innerHTML = `
        <div class="flex items-center gap-4">
          <div class="flex items-center justify-center rounded-full shrink-0 size-12"
               style="background:${bgColor}33; color:${iconColor}">
            <span class="material-symbols-outlined">${isGain ? "add" : "remove"}</span>
          </div>

          <div class="flex flex-col">
            <p class="text-[#111418] dark:text-white text-base font-medium">${title}</p>
            <p class="text-[#617589] dark:text-gray-400 text-sm">${detail}</p>
          </div>
        </div>

        <div>
          <p style="color:${amountColor}" class="text-base font-bold">${sign}${Math.abs(log.change_amount)}</p>
        </div>
      `;

      list.appendChild(item);
    });
  }
</script>

</body>
</html>
