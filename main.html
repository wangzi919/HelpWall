<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Community Help Board</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // === Supabase 初始化 ===
        const SUPABASE_URL = "https://zyeykllnefwvlokrecbv.supabase.co"; // ← 換成你的 Supabase Project URL
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5ZXlrbGxuZWZ3dmxva3JlY2J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDg2MjQsImV4cCI6MjA3ODYyNDYyNH0.zTx11lXOPAdeakTXQch9OEO4c7rfhMImNaKDz4G9DIs"; // ← 換成你的 anon public key
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#A0E7E5",
                        "accent": "#FFBF86",
                        "background-light": "#FFFDF5",
                        "text-primary": "#4A4A4A",
                        "text-secondary": "#7D7D7D",
                        "note-yellow": "#FFFACD",
                        "note-blue": "#D4F1F4",
                        "note-pink": "#FFDAB9",
                    },
                    fontFamily: {
                        "display": ["Spline Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "1.25rem",
                        "lg": "1.5rem",
                        "xl": "1.875rem",
                        "full": "9999px"
                    },
                    boxShadow: {
                        'soft': '0 4px 10px rgba(0, 0, 0, 0.05)',
                    }
                },
            },
        }
    </script>

    <style type="text/tailwindcss">
        @layer base {
            .material-symbols-outlined {
                font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            }
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
            position: fixed;
            width: 100%;
        }
        #map {
            height: calc(100vh - 60px - 56px);
            width: 100%;
            z-index: 5;
        }
        
        .leaflet-div-icon { background: transparent; border: none; }
        .map-marker-bubble {
            display: inline-block;                /* 讓寬度依文字自動調整 */
            position: relative;
            
            padding: 8px 12px;
            border-radius: 1.25rem;
            background-color: var(--marker-color); /* 背景顏色跟著變 */
            
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);

            font-family: "Spline Sans", sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: #4A4A4A;
            
            white-space: nowrap;                  /* 不換行，自動延伸 */
        }

        /* 下方尖角 */
        .map-marker-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);

            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid var(--marker-color); /* 尖角同色 */
        }

        /* 進行中：灰色 + 半透明（你已有的邏輯） */
        .map-marker-bubble.taken {
            background-color: #A9A9A9 !important;
            opacity: 0.6;
        }

        .map-marker-bubble.taken::after {
            border-top-color: #A9A9A9 !important;
        }

        .user-marker {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
            width: 40px;
            border-radius: 9999px;
            background-color: #A0E7E5;
            border: 3px solid #FFFDF5;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .user-marker .material-symbols-outlined {
            color: #4A4A4A;
            font-size: 24px;
            font-variation-settings: 'FILL' 1;
        }
    </style>
</head>
<body class="bg-background-light font-display">
    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden text-text-primary">
        <!-- App Bar -->
        <div class="sticky top-0 z-10 flex items-center justify-between bg-background-light/80 px-4 py-3 backdrop-blur-sm">
            <div class="flex size-12 shrink-0 items-center justify-start">
                <div id="nav-user-avatar"
                    class="aspect-square size-10 rounded-full bg-cover bg-center shadow-soft cursor-pointer">
                </div>
            </div>
            <div class="flex items-center justify-center">
                <button class="flex items-center justify-center p-2 rounded-full text-text-secondary hover:bg-black/5">
                    <span class="material-symbols-outlined text-2xl">search</span>
                </button>
            </div>
            <div class="flex size-12 shrink-0 items-center justify-end">
                <button class="relative flex items-center justify-center p-2 rounded-full text-text-secondary hover:bg-black/5">
                    <span class="material-symbols-outlined text-2xl">notifications</span>
                    <span class="absolute top-1 right-1 flex h-4 w-4 items-center justify-center rounded-full bg-accent text-xs font-bold text-white">3</span>
                </button>
            </div>
        </div>

        <!-- Segmented Buttons -->
        <div class="px-4 py-2 z-10">
            <div class="flex h-12 items-center justify-center rounded-full bg-black/5 p-1 shadow-inner">
                <label class="flex h-full grow cursor-pointer items-center justify-center rounded-full px-3 has-[:checked]:bg-white has-[:checked]:shadow-soft text-sm font-medium transition-all">
                    <span>Wall View</span>
                    <input checked class="invisible w-0" name="view-toggle" type="radio" id="view-wall" />
                </label>
                <label class="flex h-full grow cursor-pointer items-center justify-center rounded-full px-3 has-[:checked]:bg-white has-[:checked]:shadow-soft text-sm font-medium transition-all">
                    <span>Map View</span>
                    <input class="invisible w-0" name="view-toggle" type="radio" id="view-map" />
                </label>
            </div>
        </div>

        <!-- Help Request Cards Grid -->
        <main id="wall-view-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 p-4 pb-24 overflow-y-auto" style="height: calc(100vh - 60px - 56px);"></main>

        <main id="map-view-container" class="hidden">
            <div id="map"></div>
        </main>

        <!-- 新增任務按鈕 -->
        <div class="fixed bottom-6 right-6 z-20">
            <button id="add-btn" class="flex h-16 w-16 items-center justify-center rounded-full bg-primary text-text-primary shadow-lg transition-transform hover:scale-105">
                <span class="material-symbols-outlined text-4xl">add</span>
            </button>
        </div>

        <!-- 新增任務表單 -->
        <div id="task-form" class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 w-80 shadow-lg flex flex-col gap-3">
                <h2 class="text-lg font-bold">Add New Help Task</h2>
                
                <input id="task-title" placeholder="Title" class="border rounded-lg p-2" />
                <textarea id="task-desc" placeholder="Description" class="border rounded-lg p-2"></textarea>
                
                <div id="expected-time-btn" 
                    class="border rounded-lg p-2 cursor-pointer text-gray-500 bg-gray-50 hover:bg-gray-100 flex justify-between items-center">
                    <span id="expected-time-display">Select Expected Time</span>
                    <span class="material-symbols-outlined text-base">expand_more</span>
                </div>
                
                <input id="task-image-url" placeholder="Image URL (Optional)" class="border rounded-lg p-2" /> 
                <button id="submit-task" class="bg-blue-500 text-white rounded-lg py-2 hover:opacity-90">Submit</button>
                <button id="close-task" class="text-sm text-gray-500 mt-2">Cancel</button>
            </div>
        </div>

        <div id="time-picker-modal"
            class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-[999]">
            <!-- Time Picker Modal Content -->
            <div class="bg-white rounded-xl p-4 w-64 shadow-lg">
                <h3 class="text-lg font-bold mb-3">Select Expected Time</h3>
                <div id="time-options" class="flex flex-col gap-2">
                    <!-- JS 會自動插入選項 -->
                </div>
                <button id="close-time-picker" class="text-sm text-gray-500 mt-3 w-full">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const viewWallRadio = document.getElementById('view-wall');
        const viewMapRadio = document.getElementById('view-map');
        const wallContainer = document.getElementById('wall-view-container');
        const mapContainer = document.getElementById('map-view-container');
        const mapElement = document.getElementById('map');
        const form = document.getElementById('task-form');
        const addBtn = document.getElementById('add-btn');
        const closeBtn = document.getElementById('close-task');
        const submitBtn = document.getElementById('submit-task');
        const expectedTimeBtn = document.getElementById("expected-time-btn");
        const timePickerModal = document.getElementById("time-picker-modal");
        const timeOptionsContainer = document.getElementById("time-options");
        const expectedTimeDisplay = document.getElementById("expected-time-display");
        const closeTimePicker = document.getElementById("close-time-picker");
        const urlParams = new URLSearchParams(window.location.search);
        const timeOptions = [5, 10, 15, 20, 25, 30];

        let map = null;
        let markers = [];
        let isMapInitialized = false;
        let userCurrentLat = 25.0330; // 預設值 (台北)
        let userCurrentLng = 121.5654; // 預設值 (台北)
        let selectedExpectedTime = null; //會被寫入 task_detail.expected_time

        let userId = null;

        // 開啟 modal
        expectedTimeBtn.addEventListener("click", () => {
            timePickerModal.classList.remove("hidden");
        });

        // 建立按鈕
        timeOptionsContainer.innerHTML = timeOptions
            .map(t => `
                <div class="p-2 border rounded-lg bg-gray-50 hover:bg-gray-100 cursor-pointer text-center"
                    data-value="${t}">
                    ${t} minutes
                </div>
            `)
            .join("");

        // 選擇後關閉
        timeOptionsContainer.addEventListener("click", (e) => {
            const value = e.target.getAttribute("data-value");
            if (value) {
                selectedExpectedTime = `${value} minutes`;
                expectedTimeDisplay.textContent = selectedExpectedTime;
                expectedTimeDisplay.classList.remove("text-gray-500");
                expectedTimeDisplay.classList.add("text-black");
                timePickerModal.classList.add("hidden");
            }
        });

        // 點背景關閉
        timePickerModal.addEventListener("click", (e) => {
            if (e.target === timePickerModal) {
                timePickerModal.classList.add("hidden");
            }
        });

        // Cancel
        closeTimePicker.addEventListener("click", () => {
            timePickerModal.classList.add("hidden");
        });

        async function initApp() {
            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                // 沒登入 -> 踢回首頁
                window.location.href = 'index.html';
                return;
            }

            userId = user.id;
            console.log("Current User UUID:", userId);

            loadCurrentUser();
            loadTasks();
            
            if (viewMapRadio.checked) {
                initMap();
            }
        }

        initApp();

        // === 讀取登入使用者的頭像 ===
        async function loadCurrentUser() {
            const { data: userProfile, error } = await supabase
                .from('user')
                .select('*')
                .eq('uid', userId) // 使用 UUID
                .single();

            if (error) {
                console.error("無法讀取使用者資料", error);
                return;
            }

            const avatar = document.getElementById("nav-user-avatar");
            if (avatar && userProfile.image_url) {
                avatar.style.backgroundImage = `url('${userProfile.image_url}')`;
            }

            avatar.addEventListener("click", () => {
                // 去個人頁面，不需要帶參數，預設就是看自己
                window.location.href = `user_profile.html`; 
            });
        }

        // === 從 Supabase 載入任務 ===
        async function loadTasks() {
            const { data: tasks, error } = await supabase
                .from('tasks')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                return;
            }

            wallContainer.innerHTML = "";
            markers.forEach(m => map && map.removeLayer(m));
            markers = [];

            for (const task of tasks) {

                // 查詢任務媒合情況
                const { data: assignment } = await supabase
                    .from("task_assignment")
                    .select("*")
                    .eq("task_id", task.id)
                    .maybeSingle();

                // 依狀態判斷
                const isTaken = assignment?.status === "in_progress";
                const isCompleted = assignment?.status === "completed";

                // 卡片 UI
                if (isCompleted) continue; // 已完成不顯示
                const card = document.createElement('div');
                card.className = "task-card flex flex-col rounded-lg p-4 shadow-soft transition-transform duration-200 ease-in-out hover:-translate-y-1 cursor-pointer";
                card.style.backgroundColor = task.color || "#FFFACD";

                let statusBadge = "";
                if (isTaken) {
                    statusBadge = `<span class="text-xs px-2 py-1 bg-gray-400 text-white rounded-full">進行中</span>`;
                } else {
                    statusBadge = `<span class="text-xs px-2 py-1 bg-green-500 text-white rounded-full">可接任務</span>`;
                }
                
                card.innerHTML = `
                    <div class="w-full aspect-video rounded-lg bg-cover bg-center"
                        style="background-image:url(${task.image_url})"></div>

                    <div class="flex flex-col gap-1 pt-4">

                        <div class="flex items-center gap-2">
                            <p class="text-text-secondary text-sm font-medium">${task.distance || 'nearby'}</p>
                            ${statusBadge}
                        </div>

                        <p class="text-text-primary text-lg font-bold">${task.title}</p>
                        <p class="text-text-secondary text-base">${task.description}</p>
                    </div>`;

                // 點擊跳到 task detail
                card.addEventListener('click', () => {
                    window.location.href = `task_detail.html?task_id=${task.id}`;
                });

                wallContainer.appendChild(card);

                // 地圖標記
                if (map && task.lat && task.lng) {
                    const html = `
                        <div class="map-marker-bubble" 
                            style="--marker-color:${task.color};
                                    background-color:${isTaken ? '#A9A9A9' : task.color};
                                    opacity:${isTaken ? 0.5 : 1};
                            ">
                            ${task.title}
                        </div>`;

                    const icon = L.divIcon({ className: '', html, iconAnchor: [50, 45] });
                    const marker = L.marker([task.lat, task.lng], { icon }).addTo(map);
                    markers.push(marker);

                    marker.on('click', () => {
                        window.location.href = `task_detail.html?task_id=${task.id}`;
                    });
                }
            }
        }

        // 地圖初始化
        function initMap() {
            if (isMapInitialized) return;

            // 1. 嘗試獲取使用者位置
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const realLat = position.coords.latitude;
                        const realLng = position.coords.longitude;

                        userCurrentLat = realLat;
                        userCurrentLng = realLng;
                        
                        initializeMapWithCoords(realLat, realLng);
                    },
                    (error) => {
                        console.error("無法取得使用者位置，使用預設位置 (台北 101):", error);
                        initializeMapWithCoords(userCurrentLat, userCurrentLng); // 預設位置
                    },
                    {
                        // 可選：設定選項，如啟用高精準度、逾時時間等
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                console.error("瀏覽器不支援 Geolocation API，使用預設位置 (台北 101)。");
                initializeMapWithCoords(userCurrentLat, userCurrentLng);
            }
        }

        function initializeMapWithCoords(latitude, longitude) {
            if (isMapInitialized) return;
            isMapInitialized = true;

            // 建立 Leaflet 經緯度物件
            const userLatLng = L.latLng(latitude, longitude);

            // 初始化地圖並設定中心點和縮放級別
            map = L.map(mapElement).setView(userLatLng, 14);

            // 添加地圖圖層
            L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const userIcon = L.divIcon({
                className: '',
                html: `<div class="user-marker"><span class="material-symbols-outlined">person_pin</span></div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });

            L.marker(userLatLng, { icon: userIcon }).addTo(map);

            console.log(`地圖已初始化於：(${latitude}, ${longitude})`);
        }

        // 切換 Wall/Map
        function handleViewChange() {
            if (viewMapRadio.checked) {
                wallContainer.classList.add('hidden');
                mapContainer.classList.remove('hidden');
                initMap();
                if (map) {
                    map.invalidateSize();
                    loadTasks();
                }
            } else {
                wallContainer.classList.remove('hidden');
                mapContainer.classList.add('hidden');
            }
        }

        viewWallRadio.addEventListener('change', handleViewChange);
        viewMapRadio.addEventListener('change', handleViewChange);

        // === 新增任務 ===
        addBtn.addEventListener('click', () => form.classList.remove('hidden'));
        closeBtn.addEventListener('click', () => form.classList.add('hidden'));
        submitBtn.addEventListener('click', async () => {
            const title = document.getElementById('task-title').value.trim();
            const desc = document.getElementById('task-desc').value.trim();
            const imageUrl = document.getElementById('task-image-url').value.trim();

            if (!title) return alert("請輸入任務標題");
            if (!selectedExpectedTime) return alert("請選擇預期時間");

            const newTask = {
                user_uid: userId,
                title,
                description: desc,
                image_url: imageUrl,
                lat: userCurrentLat,
                lng: userCurrentLng,
                color: ["#FFFACD", "#FFDAB9", "#D4F1F4"][Math.floor(Math.random() * 3)],
                distance: "nearby"
            };

            // === 1. 新增 tasks 並取得 task id ===
            const { data: insertedTask, error: taskError } = await supabase
                .from("tasks")
                .insert([newTask])
                .select()
                .single();

            if (taskError) {
                alert("新增失敗：" + taskError.message);
                return;
            }

            const taskId = insertedTask.id;
            const time_credit = selectedExpectedTime / 5;

            // === 2. 新增 task_detail ===
            const detailRow = {
                task_id: taskId,
                full_description: null,
                contact_method: null,
                expected_time: selectedExpectedTime,
                time_credit: time_credit
            };

            const { error: detailError } = await supabase
                .from("task_detail")
                .insert([detailRow]);

            if (detailError) {
                console.error(detailError);
                alert("task 建立成功，但新增 task_detail 失敗");
                return;
            }

            // === 3. UI reset ===
            form.classList.add('hidden');

            document.getElementById('task-title').value = "";
            document.getElementById('task-desc').value = "";
            document.getElementById('task-image-url').value = "";
            expectedTimeDisplay.textContent = "Select Expected Time";
            expectedTimeDisplay.classList.add("text-gray-500");
            expectedTimeDisplay.classList.remove("text-black");
            selectedExpectedTime = null;

            await loadTasks();
        });
    </script>
</body>
</html>
