<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Community Help Board</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // === Supabase ÂàùÂßãÂåñ ===
        const SUPABASE_URL = "https://zyeykllnefwvlokrecbv.supabase.co"; // ‚Üê ÊèõÊàê‰Ω†ÁöÑ Supabase Project URL
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5ZXlrbGxuZWZ3dmxva3JlY2J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDg2MjQsImV4cCI6MjA3ODYyNDYyNH0.zTx11lXOPAdeakTXQch9OEO4c7rfhMImNaKDz4G9DIs"; // ‚Üê ÊèõÊàê‰Ω†ÁöÑ anon public key
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#A0E7E5",
                        "accent": "#FFBF86",
                        "background-light": "#FFFDF5",
                        "text-primary": "#4A4A4A",
                        "text-secondary": "#7D7D7D",
                        "note-yellow": "#FFFACD",
                        "note-blue": "#D4F1F4",
                        "note-pink": "#FFDAB9",
                    },
                    fontFamily: {
                        "display": ["Spline Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "1.25rem",
                        "lg": "1.5rem",
                        "xl": "1.875rem",
                        "full": "9999px"
                    },
                    boxShadow: {
                        'soft': '0 4px 10px rgba(0, 0, 0, 0.05)',
                    }
                },
            },
        }
    </script>

    <style type="text/tailwindcss">
        @layer base {
            .material-symbols-outlined {
                font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            }
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
            overflow: hidden;
        }
        #map {
            height: calc(100vh - 60px - 56px);
            width: 100%;
            z-index: 5;
        }
        .leaflet-div-icon { background: transparent; border: none; }
        .map-marker-bubble {
            position: relative;
            padding: 8px 12px;
            border-radius: 1.25rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-family: "Spline Sans", sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: #4A4A4A;
            white-space: nowrap;
        }
        .map-marker-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid var(--marker-color);
        }
        .user-marker {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
            width: 40px;
            border-radius: 9999px;
            background-color: #A0E7E5;
            border: 3px solid #FFFDF5;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .user-marker .material-symbols-outlined {
            color: #4A4A4A;
            font-size: 24px;
            font-variation-settings: 'FILL' 1;
        }
    </style>
</head>
<body class="bg-background-light font-display">
    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden text-text-primary">
        <!-- App Bar -->
        <div class="sticky top-0 z-10 flex items-center justify-between bg-background-light/80 px-4 py-3 backdrop-blur-sm">
            <div class="flex size-12 shrink-0 items-center justify-start">
                <div class="aspect-square size-10 rounded-full bg-cover bg-center" 
                     style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuBQYlQA11OnSNtFQvN0zcKx3cR7AxTbl7Wt9Vu2t7iPtEJIkhj0Tl0CNQN5ovPmGMTctD-_lWwr3WgURxHM6Rn-j9AIAP-HkPUPad89TSL4DhBp_tnv-6czGFxUn2JhXIOkE4MbgHOUpmKn5im4CZK2UTWhNnSOC-FtSigZk_9wSx1la6z2Qem_HHuzHNgej_o6IPBEObLDSCeNy4Jx3qfgsxFYFWpiRLEDWVonuKWGlHAC2sUcamXDybAo0dM5Nl187yd1iw8sLz7M')">
                </div>
            </div>
            <div class="flex items-center justify-center">
                <button class="flex items-center justify-center p-2 rounded-full text-text-secondary hover:bg-black/5">
                    <span class="material-symbols-outlined text-2xl">search</span>
                </button>
            </div>
            <div class="flex size-12 shrink-0 items-center justify-end">
                <button class="relative flex items-center justify-center p-2 rounded-full text-text-secondary hover:bg-black/5">
                    <span class="material-symbols-outlined text-2xl">notifications</span>
                    <span class="absolute top-1 right-1 flex h-4 w-4 items-center justify-center rounded-full bg-accent text-xs font-bold text-white">3</span>
                </button>
            </div>
        </div>

        <!-- Segmented Buttons -->
        <div class="px-4 py-2 z-10">
            <div class="flex h-12 items-center justify-center rounded-full bg-black/5 p-1 shadow-inner">
                <label class="flex h-full grow cursor-pointer items-center justify-center rounded-full px-3 has-[:checked]:bg-white has-[:checked]:shadow-soft text-sm font-medium transition-all">
                    <span>Wall View</span>
                    <input checked class="invisible w-0" name="view-toggle" type="radio" id="view-wall" />
                </label>
                <label class="flex h-full grow cursor-pointer items-center justify-center rounded-full px-3 has-[:checked]:bg-white has-[:checked]:shadow-soft text-sm font-medium transition-all">
                    <span>Map View</span>
                    <input class="invisible w-0" name="view-toggle" type="radio" id="view-map" />
                </label>
            </div>
        </div>

        <!-- Help Request Cards Grid -->
        <main id="wall-view-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 p-4 pb-24 overflow-y-auto" style="height: calc(100vh - 60px - 56px);"></main>

        <main id="map-view-container" class="hidden">
            <div id="map"></div>
        </main>

        <!-- Êñ∞Â¢û‰ªªÂãôÊåâÈàï -->
        <div class="fixed bottom-6 right-6 z-20">
            <button id="add-btn" class="flex h-16 w-16 items-center justify-center rounded-full bg-primary text-text-primary shadow-lg transition-transform hover:scale-105">
                <span class="material-symbols-outlined text-4xl">add</span>
            </button>
        </div>

        <!-- Êñ∞Â¢û‰ªªÂãôË°®ÂñÆ -->
        <div id="task-form" class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 w-80 shadow-lg flex flex-col gap-3">
                <h2 class="text-lg font-bold">Add New Help Task</h2>
                <input id="task-title" placeholder="Title" class="border rounded-lg p-2" />
                <textarea id="task-desc" placeholder="Description" class="border rounded-lg p-2"></textarea>
                <button id="submit-task" class="bg-primary text-white rounded-lg py-2 hover:opacity-90">Submit</button>
                <button id="close-task" class="text-sm text-gray-500 mt-2">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const viewWallRadio = document.getElementById('view-wall');
        const viewMapRadio = document.getElementById('view-map');
        const wallContainer = document.getElementById('wall-view-container');
        const mapContainer = document.getElementById('map-view-container');
        const mapElement = document.getElementById('map');
        const form = document.getElementById('task-form');
        const addBtn = document.getElementById('add-btn');
        const closeBtn = document.getElementById('close-task');
        const submitBtn = document.getElementById('submit-task');

        let map = null;
        let markers = [];
        let isMapInitialized = false;

        // === Âæû Supabase ËºâÂÖ•‰ªªÂãô ===
        async function loadTasks() {
            const { data: tasks, error } = await supabase.from('tasks').select('*').order('created_at', { ascending: false });
            if (error) {
                console.error(error);
                return;
            }

            console.log("üü¢ ÊàêÂäüËºâÂÖ•‰ªªÂãôË≥áÊñô:", tasks.length, "Á≠Ü");

            wallContainer.innerHTML = "";
            markers.forEach(m => map && map.removeLayer(m));
            markers = [];

            tasks.forEach(task => {
                // Âç°Áâá
                const card = document.createElement('div');
                card.className = "task-card flex flex-col rounded-lg p-4 shadow-soft transition-transform duration-200 ease-in-out hover:-translate-y-1 cursor-pointer";
                card.style.backgroundColor = task.color || "#FFFACD";
                card.innerHTML = `
                    <div class="w-full aspect-video rounded-lg bg-cover bg-center" style="background-image:url('https://picsum.photos/seed/${task.id}/400/300')"></div>
                    <div class="flex flex-col gap-1 pt-4">
                        <p class="text-text-secondary text-sm font-medium">${task.distance || 'nearby'}</p>
                        <p class="text-text-primary text-lg font-bold">${task.title}</p>
                        <p class="text-text-secondary text-base">${task.description}</p>
                    </div>`;
                wallContainer.appendChild(card);

                // Âú∞ÂúñÊ®ôË®ò
                if (map && task.lat && task.lng) {
                    const html = `<div class="map-marker-bubble" style="--marker-color:${task.color};background-color:${task.color};">${task.title}</div>`;
                    const icon = L.divIcon({ className: '', html, iconAnchor: [50, 45] });
                    const marker = L.marker([task.lat, task.lng], { icon }).addTo(map);
                    markers.push(marker);
                }
            });
        }

        // Âú∞ÂúñÂàùÂßãÂåñ
        function initMap() {
            if (isMapInitialized) return;
            isMapInitialized = true;
            const userLatLng = L.latLng(25.0330, 121.5654);
            map = L.map(mapElement).setView(userLatLng, 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            const userIcon = L.divIcon({
                className: '',
                html: `<div class="user-marker"><span class="material-symbols-outlined">person_pin</span></div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            });
            L.marker(userLatLng, { icon: userIcon }).addTo(map);
        }

        // ÂàáÊèõ Wall/Map
        function handleViewChange() {
            if (viewMapRadio.checked) {
                wallContainer.classList.add('hidden');
                mapContainer.classList.remove('hidden');
                initMap();
                if (map) {
                    map.invalidateSize();
                    loadTasks();
                }
            } else {
                wallContainer.classList.remove('hidden');
                mapContainer.classList.add('hidden');
            }
        }

        viewWallRadio.addEventListener('change', handleViewChange);
        viewMapRadio.addEventListener('change', handleViewChange);

        // === Êñ∞Â¢û‰ªªÂãô ===
        addBtn.addEventListener('click', () => form.classList.remove('hidden'));
        closeBtn.addEventListener('click', () => form.classList.add('hidden'));
        submitBtn.addEventListener('click', async () => {
            const title = document.getElementById('task-title').value.trim();
            const desc = document.getElementById('task-desc').value.trim();
            if (!title) return alert("Ë´ãËº∏ÂÖ•‰ªªÂãôÊ®ôÈ°å");

            const newTask = {
                user_id: 1,
                title,
                description: desc,
                lat: 25.033 + Math.random() * 0.02,
                lng: 121.565 + Math.random() * 0.02,
                color: ["#FFFACD", "#FFDAB9", "#D4F1F4"][Math.floor(Math.random() * 3)],
                distance: "nearby"
            };

            const { error } = await supabase.from('tasks').insert([newTask]);
            if (error) alert("Êñ∞Â¢ûÂ§±ÊïóÔºö" + error.message);
            else {
                form.classList.add('hidden');
                document.getElementById('task-title').value = "";
                document.getElementById('task-desc').value = "";
                await loadTasks();
            }
        });

        loadTasks();
    </script>
</body>
</html>
