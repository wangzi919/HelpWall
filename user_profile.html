<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>User Profile - HelpWall</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <style type="text/tailwindcss">
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24;
    }
  </style>

  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#308ce8",
            "background-light": "#FFFDF5",
            "background-dark": "#111921",
            "text-main": "#4A4A4A",
            "accent-yellow": "#FFF5B8",
            "accent-mint": "#D5F0E1",
            "accent-blue": "#C9E6FF",
            "accent-pink": "#FFD8CC"
          },
          fontFamily: {
            display: ["Nunito", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "1rem",
            lg: "2rem",
            xl: "3rem",
            full: "9999px"
          },
          boxShadow: { soft: "0 4px 12px rgba(0, 0, 0, 0.05)" }
        }
      }
    };
  </script>

  <style>
    body { min-height: max(884px, 100dvh); }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-text-main">

<div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">
  
  <!-- Top App Bar -->
  <div class="flex items-center p-4 pb-2 justify-between bg-background-light dark:bg-background-dark sticky top-0 z-10">
    <button onclick="history.back()" class="flex size-12 items-center">
      <span class="material-symbols-outlined text-text-main">arrow_back</span>
    </button>

    <h2 class="text-text-main text-lg font-bold flex-1 text-center">My Profile</h2>

    <div class="flex w-12 items-center justify-end">
      <button class="flex items-center justify-center h-12 text-text-main">
        <span class="material-symbols-outlined">settings</span>
      </button>
    </div>
  </div>

  <!-- Profile Header -->
  <div class="flex p-4">
    <div class="flex w-full flex-col gap-4 items-center">

      <div class="flex gap-4 flex-col items-center">
        <div id="profile-avatar"
             class="bg-center bg-cover rounded-full min-h-32 w-32 shadow-soft border-4 border-white"
             style="background-image: url('https://placehold.co/200x200');">
        </div>

        <div class="flex flex-col items-center">
          <p id="profile-name" class="text-text-main text-[22px] font-extrabold text-center">
            Loading...
          </p>
          <p id="profile-bio" class="text-gray-500 text-base text-center mt-1">
            &nbsp;
          </p>
        </div>
      </div>

      <button class="flex cursor-pointer items-center justify-center rounded-full h-12 px-6 bg-accent-yellow text-text-main font-bold shadow-soft border border-yellow-200 w-full max-w-[480px]">
        Edit Profile
      </button>

    </div>
  </div>
  <!-- Stats -->
  <div class="flex flex-wrap gap-4 p-4">
    <div class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-5 bg-accent-mint shadow-soft items-center text-center">
      <span class="material-symbols-outlined text-text-main text-3xl">volunteer_activism</span>
      <p class="text-text-main text-base font-bold leading-normal">Help Given</p>
      <p id="stat-help-given" class="text-text-main text-2xl font-extrabold leading-tight">0</p>
    </div>

    <div class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-5 bg-accent-pink shadow-soft items-center text-center">
      <span class="material-symbols-outlined text-text-main text-3xl">record_voice_over</span>
      <p class="text-text-main text-base font-bold leading-normal">Requests Made</p>
      <p id="stat-requests" class="text-text-main text-2xl font-extrabold leading-tight">0</p>
    </div>

    <div class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-5 bg-accent-blue shadow-soft items-center text-center">
      <span class="material-symbols-outlined text-text-main text-3xl">favorite</span>
      <p class="text-text-main text-base font-bold leading-normal">Thank Yous</p>
      <p id="stat-thanks" class="text-text-main text-2xl font-extrabold leading-tight">0</p>
    </div>
  </div>

  <!-- Tabs -->
  <div class="pb-3 px-4">
    <div class="flex border-b border-gray-200 justify-between">

      <button id="tab-my-requests" 
              class="flex flex-col items-center justify-center border-b-[3px] border-b-text-main text-text-main pb-[13px] pt-4 flex-1">
        <p class="text-text-main text-sm font-bold">My Requests</p>
      </button>

      <button id="tab-my-help" 
              class="flex flex-col items-center justify-center border-b-[3px] border-transparent text-gray-500 pb-[13px] pt-4 flex-1">
        <p class="text-gray-500 text-sm font-bold">My Help</p>
      </button>
    </div>
  </div>

  <!-- List Items -->
  <div id="task-list" class="flex flex-col gap-3 p-4">
    <!-- JS will insert tasks here -->
  </div>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://zyeykllnefwvlokrecbv.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5ZXlrbGxuZWZ3dmxva3JlY2J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDg2MjQsImV4cCI6MjA3ODYyNDYyNH0.zTx11lXOPAdeakTXQch9OEO4c7rfhMImNaKDz4G9DIs";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// URL ?id=xx
const urlParams = new URLSearchParams(window.location.search);
const userId = urlParams.get("user_id");

if (!userId) {
  console.error("❌ No user id in URL");
}

loadUserProfile(userId);
loadUserStats(userId);
loadUserRequests(userId);

/* -------------------------------
   1. 讀取使用者資料
-------------------------------- */
async function loadUserProfile(id) {
  const { data: user, error } = await sb
    .from("user")
    .select("*")
    .eq("id", id)
    .single();

  if (error) {
    console.error("❌ Failed loading user:", error);
    return;
  }

  // 頭像
  document.getElementById("profile-avatar").style.backgroundImage =
    `url('${user.image_url}')`;

  // 名字
  document.getElementById("profile-name").textContent = user.name;

  // 簡介（若沒有就留空）
  document.getElementById("profile-bio").textContent = user.bio ?? "";
}

/* -------------------------------
   2. 統計數據
-------------------------------- */
async function loadUserStats(id) {
  // Requests Made
  const { count: requestsCount } = await sb
    .from("tasks")
    .select("*", { count: "exact", head: true })
    .eq("user_id", id);
  document.getElementById("stat-requests").textContent = requestsCount || 0;

  // Help Given
  const { count: helpCount } = await sb
    .from("comments")
    .select("*", { count: "exact", head: true })
    .eq("user_id", id);
  document.getElementById("stat-help-given").textContent = helpCount || 0;

  // Thank Yous
  const { count: thanksCount } = await sb
    .from("thanks_card")
    .select("*", { count: "exact", head: true })
    .eq("receiver_id", id);
  document.getElementById("stat-thanks").textContent = thanksCount || 0;
}

/* -------------------------------
   3. 我的 Requests
-------------------------------- */
async function loadUserRequests(id) {
  const { data: tasks, error } = await sb
    .from("tasks")
    .select("*")
    .eq("user_id", id)
    .order("created_at", { ascending: false });

  if (error) {
    console.error("❌ Failed loading tasks:", error);
    return;
  }

  const container = document.getElementById("task-list");
  container.innerHTML = "";

  tasks.forEach(task => {
    const item = document.createElement("div");
    item.className =
      "flex items-center gap-4 bg-white dark:bg-background-dark rounded-xl p-4 min-h-[72px] justify-between shadow-soft cursor-pointer";

    item.onclick = () =>
      (window.location.href = `task_detail.html?id=${task.id}`);

    item.innerHTML = `
      <div class="flex items-center gap-4">
        <div class="flex items-center justify-center rounded-lg bg-accent-yellow shrink-0 size-12">
          <span class="material-symbols-outlined text-text-main">task</span>
        </div>
        <div class="flex flex-col justify-center">
          <p class="text-text-main text-base font-bold">${task.title}</p>
          <p class="text-gray-500 text-sm">${timeAgo(task.created_at)}</p>
        </div>
      </div>

      <div class="shrink-0 flex items-center justify-center text-gray-400 size-7">
        <span class="material-symbols-outlined">chevron_right</span>
      </div>
    `;

    container.appendChild(item);
  });
}

function timeAgo(ts) {
  const diff = (Date.now() - new Date(ts)) / 1000;
  if (diff < 3600) return Math.floor(diff / 60) + " min ago";
  if (diff < 86400) return Math.floor(diff / 3600) + " hr ago";
  return Math.floor(diff / 86400) + " days ago";
}
</script>
